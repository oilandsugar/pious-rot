{{ $currentSection := (index (split .Path "/") 1)}}
{{ $currentPage := .Page }}
<aside>
    <div class="gael accent medium-margin-bottom">Table of contents</div>
    <ul class="side-menu">
        <li><a href="/">Home</a></li>
        {{ range .Site.Sections }}
        <li><a class="{{ if eq $currentPage . }}current{{ end }}" href="{{ .Permalink }}">{{ .Title }}</a></li>
        {{ $parentPage := .Page }}
        {{ $parentPage.Slug }}
        <ul>
            {{ range (where .Site.Pages "Section" $parentPage.Slug ) }}
            {{ if and (.IsSection) (ne .Page $parentPage) }}
            <li>
                <details {{ if eq $currentSection (index (split .Path "/") 1) }}open{{ end }}>
                    <summary><a class="{{ if eq $currentPage . }}current{{ end }}" href="{{ .Permalink }}">{{ .Params.subtitle }}</a></summary>
                    {{ $parent := .Page }}
                    {{ $parent.Slug }}
                    <ul>
                        {{ range .RegularPages }}
                        <li>
                            <a class="{{ if eq $currentPage . }}current{{ end }}" href="{{ .Permalink }}">{{ .Params.subtitle }}</a>
                        </li>
                        {{ end }}
                    </ul>
                </details>
            </li>
            {{ end }}
            {{ end }}
        </ul>

        {{ end }}
    </ul>
</aside>